/* LCD game JavaScript library v0.3.4 -- by BdR 2019 */

var LCDGAME_VERSION="0.3.4",LCDGame=LCDGame||{loadsounds:null,countimages:0,scaleFactor:1,score:0,gametype:0,level:0,buttonpress:0,playtimestart:null,onImageLoaded:null,onImageError:null,canvas:null,context2d:null,debugtxt:null};LCDGame.State=function(){this.lcdgame=null,this.key="",this.statemanager=null},LCDGame.State.prototype={init:function(){},preload:function(){},loadUpdate:function(){},loadRender:function(){},create:function(){},update:function(){}},LCDGame.State.prototype.constructor=LCDGame.State,LCDGame.StateManager=function(t){this.lcdgame=t,this._currentState="",this._pendingState="",this.states={}},LCDGame.StateManager.prototype={add:function(t,e){return this.states[t]=new e(this.lcdgame),this._pendingState=t,e},start:function(t){this.lcdgame.cleartimers(),this._currentState&&(this.states[this._currentState].destroy,this._currentState=""),this._pendingState=t},currentState:function(){if(this._currentState)return this.states[this._currentState]},checkSwitch:function(){this._currentState!=this._pendingState&&(this._currentState=this._pendingState,this.states[this._currentState].init())}},LCDGame.AnimationFrame=function(t){this.lcdgame=t,this.raftime=null},LCDGame.AnimationFrame.prototype={start:function(){for(var t=["ms","moz","webkit","o"],e=0;e<t.length&&!window.requestAnimationFrame;e++)window.requestAnimationFrame=window[t[e]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[e]+"CancelAnimationFrame"];animationlast=0;var a=this;_timeOutID=window.requestAnimationFrame?(useSetTimeout=!1,animationLoop=function(t){return a.updateAnimFrame(t)},window.requestAnimationFrame(animationLoop)):(useSetTimeout=!0,animationLoop=function(){return a.updateSetTimeout()},window.setTimeout(this.animationLoop,0))},updateAnimFrame:function(t){this.lcdgame.state.checkSwitch(),this.raftime=Math.floor(t),this.lcdgame.updateloop(this.raftime),_timeOutID=window.requestAnimationFrame(animationLoop)},updateSetTimeout:function(){this.lcdgame.state.checkSwitch(),this.raftime=Date.now(),this.lcdgame.updateloop(this.raftime);var t=Math.floor(1e3/60);_timeOutID=window.setTimeout(animationLoop,t)}};var MENU_HTML='<div class="container">  <canvas id="mycanvas" class="gamecvs"></canvas>  <a class="mybutton btnmenu" onclick="displayInfobox();">help</a>  <a class="mybutton btnmenu" onclick="displayScorebox();">highscores</a>  <div class="infobox" id="infobox">    <div id="infocontent">      instructions    </div>    <a class="mybutton btnpop" onclick="hideInfobox();">Ok</a>  </div></div>';function displayInfobox(){hideScorebox(),document.getElementById("infobox").style.display="inherit"}function hideInfobox(){document.getElementById("infobox").style.display="none"}LCDGame.Menu=function(t,e){this.lcdgame=t};var SCORE_HTML='<div class="infobox" id="scorebox">  <div id="scoreheader">  </div>  <div id="scorecontent">    One moment...  </div>  <a class="mybutton btnnext" id="btnprev" data-direction="-1">&lt;&lt;</a>  <a class="mybutton btnnext" id="btnnext" data-direction="+1">&gt;&gt;</a>  <a class="mybutton btnpop" onclick="hideScorebox();">Ok</a></div>',HS_URL="http://bdrgames.nl/lcdgames/testphp/";function displayScorebox(){hideInfobox(),document.getElementById("scorebox").style.display="inherit"}function hideScorebox(){document.getElementById("scorebox").style.display="none"}var RANKS_PER_PAGE=10;LCDGame.HighScores=function(t,e,a){this.lcdgame=t,this.gametitle=e,this.gametypes=a,this.offset=0,this._scores_local=[],this._scores_global=[],this._scoretype=0},LCDGame.HighScores.prototype={init:function(t){var e=document.getElementById("btnprev"),a=document.getElementById("btnnext");e.addEventListener("click",this.onPrevNextButton.bind(this)),a.addEventListener("click",this.onPrevNextButton.bind(this)),this.buildHeaderHTML(),this.loadLocal(t),this.loadGlobal()},getGametype:function(){var t="";return this.gametypes&&(t=this.gametypes[this._scoretype-1]),t},loadLocal:function(t){this._scores_local=[],this._scoretype=t;var e="lcdgame_local_"+this.gametitle+"_hs"+t,a=window.localStorage.getItem(e);try{this._scores_local=JSON.parse(a)}catch(t){this._scores_local=[]}"[object Array]"!==Object.prototype.toString.call(this._scores_local)&&(this._scores_local=[])},indexLocal:function(t,e){e!=this._scoretype&&this.loadLocal(e);for(var a=-1,s=this._scores_local.length-1;0<=s&&t>this._scores_local[s].score;s--)a=s;return a},saveLocal:function(t,e,a,s){var i={player:t,score:e,level:a},n=this.indexLocal(e,s);n<0?this._scores_local.push(i):this._scores_local.splice(n,0,i);var o="lcdgame_local_"+this.gametitle+"_hs"+s;window.localStorage.setItem(o,JSON.stringify(this._scores_local)),window.localStorage.setItem("lcdgame_highscore_name",t)},saveGlobal:function(t,e,a,s,i,n){if(platform)var o=(platform.product?"&device="+platform.product:"")+(platform.os?"&os="+platform.os:"")+(platform.name?"&browser="+platform.name:"");else{var r=this.guessOsBrowser();o="&device="+r.device+"&os="+r.os+"&browser="+r.browser}var h=navigator.language,d=this.getClientGUID();this._scoretype=s;t=t.replace(/\&/g,"%26");var c=HS_URL+"newhs.php",m="gamename="+this.gametitle+"&gametype="+s+"&player="+t+"&score="+e+"&level="+a+"&playtime="+i+"&buttonpress="+n+o+"&language="+h+"&lcdversion="+LCDGAME_VERSION+"&clientguid="+d,l=new XMLHttpRequest;l.open("POST",c,!0),l.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8"),l.onreadystatechange=function(t){if(200<=l.status&&l.status<400){if(4==l.readyState&&200==l.status){console.log("SUCCESS!!\nrequest.status="+l.status+"\nrequest.response="+l.response);var e=JSON.parse(l.response);if("OK"==e.result){console.log("Highscore sent succesfully");var a=e.rank?isNaN(e.rank)?1:e.rank:1;this.offset=RANKS_PER_PAGE*Math.floor((a-1)/RANKS_PER_PAGE),this.loadGlobal(),displayScorebox()}else console.log("Highscore sent failed")}}else console.log("Highscore sent failed with error "+l.status+": "+l.statusText)}.bind(this),l.send(m)},getHighscore:function(t){var e=0;return this.lcdgame.highscores._scores_global[0]&&(e=this.lcdgame.highscores._scores_global[0].score),e},checkScore:function(){var t=new Date,e=this.lcdgame.score,a=this.lcdgame.level,s=this.lcdgame.gametype,i=Math.floor((t-this.lcdgame.playtimestart)/1e3),n=this.lcdgame.buttonpress;if(0<e){var o=window.localStorage.getItem("lcdgame_highscore_name")||"",r=prompt("New highscore, enter your name and press enter to submit or press cancel.",o);null!=r&&""!=(r=r.trim())&&(this.saveLocal(r,e,a,s),this.saveGlobal(r,e,a,s,i,n))}},loadGlobal:function(){var t=HS_URL+"geths.php?gamename="+this.gametitle+"&gametype="+this._scoretype+"&offset="+this.offset,e=new XMLHttpRequest;e.open("GET",t,!0),e.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8"),e.onreadystatechange=function(){4==e.readyState&&200==e.status&&this.afterLoadGlobal(e.responseText)}.bind(this),e.send(null)},afterLoadGlobal:function(t){try{this._scores_global=JSON.parse(t)}catch(t){this._scores_global=[]}"[object Array]"!==Object.prototype.toString.call(this._scores_global)&&(this._scores_global=[]);for(var e=0;e<this._scores_global.length;e++){this._scores_global[e].local=!1;for(var a=0;a<this._scores_local.length;a++)this._scores_global[e].player==this._scores_local[a].player&&this._scores_global[e].score==this._scores_local[a].score&&(this._scores_global[e].local=!0)}this.refreshHTML()},onFilterButton:function(t){if(t.currentTarget.dataset){var e=parseInt(t.currentTarget.dataset.gametype);this.gametype!=e&&(this.offset=0,this.loadLocal(e),this.loadGlobal())}},onPrevNextButton:function(t){if(t.currentTarget.dataset){var e=parseInt(t.currentTarget.dataset.direction),a=this.offset+(0<e?RANKS_PER_PAGE:-1*RANKS_PER_PAGE);a<0&&(a=0),0<e&&this._scores_global.length<RANKS_PER_PAGE&&(a=this.offset),this.offset!=a&&(this.offset=a,this.loadGlobal())}},buildHeaderHTML:function(){for(var t='<h1 id="scoretitle">'+this.gametitle+"</h1>",e=this.gametypes.length-1;0<=e;e--)t=t+'<a class="filter" data-gametype="'+(e+1)+'" id="filtertype'+e+'">'+this.gametypes[e]+"</a>";document.getElementById("scoreheader").innerHTML=t;for(e=0;e<this.gametypes.length;e++){document.getElementById("filtertype"+e).addEventListener("click",this.onFilterButton.bind(this))}},refreshHTML:function(){for(var t="",e=0;e<RANKS_PER_PAGE;e++){var a=this._scores_global[e];if(void 0===a)a={rank:this.offset+(e+1),player:".....",score:0,level:1,local:!1};t=t+"      <tr"+(a.local?' style="color:#f00"':"")+"><td>"+a.rank+".</td><td>"+a.player+"</td><td>"+a.score+"</td></tr>"}var s="<table>      <tr><td>Rk.</td><td>Name</td><td>Score</td></tr>"+t+"    </table>";this.lcdgame.scorecontent.innerHTML=s,s=this.gametitle+" ("+this.getGametype()+")",document.getElementById("scoretitle").innerHTML=s},uuidv4:function(){for(var t,e="",a=0;a<32;a++)t=16*Math.random()|0,8!=a&&12!=a&&16!=a&&20!=a||(e+="-"),e+=(12==a?4:16==a?3&t|8:t).toString(16);return e},getClientGUID:function(){var t=window.localStorage.getItem("lcdgame_client_guid");return t||(t=this.uuidv4(),window.localStorage.setItem("lcdgame_client_guid",t)),t},guessOsBrowser:function(){var t="",e="",a="",s=navigator.userAgent||navigator.vendor||window.opera;if(/BlackBerry|BB10|PlayBook|Passport/i.test(s)?t="BlackBerry":/GT-I9\d{3}|SM-G9\d{2}/.test(s)?t="Galaxy S-series":/SM-A\d{3}/.test(s)?t="Galaxy A-series":/SM-J\d{3}/.test(s)?t="Galaxy J-series":/SM-T\d{3}/.test(s)?t="Galaxy Tab":/SM-N\d{3}/.test(s)?t="Galaxy Note":/SAMSUNG/.test(s)?t="Samsung":/huawei/i.test(s)?t="Huawei":/kindle/.test(s)?t="Kindle":/xbox one/i.test(s)?t="Xbox One":/xbox/i.test(s)?t="Xbox 360":/playstation /i.test(s)?t=/playstation [^;) ]*/i.exec(s)||"Playstation":/nintendo wii/i.test(s)?t="Wii U":/IEMobile|Windows Phone/i.test(s)?t="Windows Phone":/iPad|iPhone|iPod/.test(s)&&!window.MSStream?t=/iPad/.test(s)?"iPad":/iPod/.test(s)?"iPod":"iPhone":/mac os|macintosh/i.test(s)&&(t="Macintosh"),/tizen /i.test(s))e=/tizen [^;)]*/i.exec(s)[0]||"Tizen";else if(/windows phone/i.test(s))e="Windows Phone";else if(/android /i.test(s))e=/android [^;)]*/i.exec(s)[0]||"Android";else if(/iPad|iPhone|iPod/.test(s)&&!window.MSStream){e="iOS "+(e=(e=(i=/(iphone os |cpu os )[^;) ]*/i.exec(s))[0]||"").replace(/cpu|iphone|os/gi,"").trim()).replace(/_/g,".")}else if(/mac os/i.test(s))e="Mac OS";else if(/windows /i.test(s)){var i;e=(i=/windows [^;)]*/i.exec(s)[0])||"Windows",/10/.test(i)&&(e="Windows 10"),/6.3/.test(i)&&(e="Windows 8.1"),/6.2/.test(i)&&(e="Windows 8"),/6.1/.test(i)&&(e="Windows 7"),/6.0/.test(i)&&(e="Windows Vista"),/5.1|5.2/.test(i)&&(e="Windows XP"),/5.0/.test(i)&&(e="Windows 2000")}else e=navigator.platform;return window.opr&&opr.addons||window.opera||0<=navigator.userAgent.indexOf(" OPR/")?a="Opera 8.0+":"undefined"!=typeof InstallTrigger?a="Firefox 1.0+":/edge/i.test(s)?a="Edge":/chrome/i.test(s)&&/google/i.test(navigator.vendor)?a="Chrome":/safari/i.test(s)&&/apple computer/i.test(navigator.vendor)?a="Safari":/iemobile/i.test(s)?a=/iemobile[^;) ]*/i.exec(s)[0]||"IEMobile":/MSIE /.test(s)?a=/MSIE [^;) ]*/.exec(s)[0]||"MSIE":/rv\:11\./.test(s)?a="MSIE 11":document.documentMode&&(a="MSIE 6-11"),{device:t=t.replace(/&|\?|\//g," ").trim(),os:e=e.replace(/&|\?|\//g," ").trim(),browser:a=a.replace(/&|\?|\//g," ").trim()}}},LCDGame.Game=function(t,e){this.gamedata=[],this.imageBackground=null,this.imageShapes=null,this.score=0,this.gametype=0,this.level=0,this.buttonpress=0,this.playtimestart=null,this.soundmute=!1,this.countimages=0,this.scaleFactor=1,this.imageBackground=new Image,this.imageShapes=new Image,this.imageBackground.addEventListener?(this.imageBackground.addEventListener("load",this.onImageLoaded.bind(this)),this.imageBackground.addEventListener("error",this.onImageError.bind(this)),this.imageShapes.addEventListener("load",this.onImageLoaded.bind(this)),this.imageShapes.addEventListener("error",this.onImageError.bind(this))):(this.imageBackground.attachEvent("load",this.onImageLoaded.bind(this)),this.imageBackground.attachEvent("error",this.onImageError.bind(this)),this.imageShapes.attachEvent("load",this.onImageLoaded.bind(this)),this.imageShapes.attachEvent("error",this.onImageError.bind(this)));var a=MENU_HTML+SCORE_HTML;return document.write(a),this.canvas=document.getElementById("mycanvas"),this.infobox=document.getElementById("infobox"),this.scorebox=document.getElementById("scorebox"),this.infocontent=document.getElementById("infocontent"),this.scorecontent=document.getElementById("scorecontent"),this.context2d=this.canvas.getContext("2d"),this.state=new LCDGame.StateManager(this),this.raf=new LCDGame.AnimationFrame(this),this.timers=[],this.loadConfig(t),e=e||"metadata/gameinfo.json",this.loadMetadata(e),this._touchdevice=!1,this},LCDGame.Game.prototype={onImageLoaded:function(){this.countimages++,2<=this.countimages&&this.initGame()},onImageError:function(){console.log("** ERROR ** lcdgame.js - onImageError.")},loadConfig:function(t){var e=new XMLHttpRequest;e.onreadystatechange=function(){e.readyState===XMLHttpRequest.DONE&&(200===e.status||0===e.status?this.onConfigLoad(JSON.parse(e.responseText)):this.onConfigError(e))}.bind(this),e.open("GET",t,!0),e.send()},onConfigLoad:function(t){this.gamedata=t,this.imageBackground.src=t.imgback,this.imageShapes.src=t.imgshapes;for(var e=0;e<this.gamedata.frames.length;e++)this.gamedata.frames[e].value=!1,this.gamedata.frames[e].valprev=!1,this.gamedata.frames[e].type="shape";for(var a=0;a<this.gamedata.sequences.length;a++){this.gamedata.sequences[a].ids=[];for(var s=0;s<this.gamedata.sequences[a].frames.length;s++){var i=this.gamedata.sequences[a].frames[s],n=this.shapeIndexByName(i);this.gamedata.sequences[a].ids.push(n)}}for(var o=0;o<this.gamedata.digits.length;o++){this.gamedata.digits[o].ids=[],this.gamedata.digits[o].locids=[];for(s=0;s<this.gamedata.digits[o].frames.length;s++){i=this.gamedata.digits[o].frames[s],n=this.shapeIndexByName(i);this.gamedata.digits[o].ids.push(n),-1!=n&&(this.gamedata.frames[n].type="digit")}for(var r=0;r<this.gamedata.digits[o].locations.length;r++){i=this.gamedata.digits[o].locations[r],n=this.shapeIndexByName(i);this.gamedata.digits[o].locids.push(n)}var h=this.gamedata.digits[o].max||"";if(""==h){for(var d=0;d<this.gamedata.digits[o].locids.length;d++)h+="8";this.gamedata.digits[o].max=h}}for(var c=0;c<this.gamedata.buttons.length;c++){this.gamedata.buttons[c].ids=[];var m=1e4,l=1e4,u=0,g=0;for(s=0;s<this.gamedata.buttons[c].frames.length;s++){i=this.gamedata.buttons[c].frames[s],n=this.shapeIndexByName(i);this.gamedata.buttons[c].ids.push(n),this.gamedata.frames[n].type="button";var f=this.gamedata.frames[n].spriteSourceSize;f.x<m&&(m=f.x),f.y<l&&(l=f.y),f.x+f.w>u&&(u=f.x+f.w),f.y+f.h>g&&(g=f.y+f.h)}var p=u-m,v=g-l,b=((m=m-p)+(u=u+p))/2,y=((l=l-v)+(g=g+v))/2;this.gamedata.buttons[c].area={x1:m,y1:l,x2:u,y2:g,xc:b,yc:y};var x=this.gamedata.buttons[c].name;void 0!==this.gamedata.buttons[c].defaultkeys&&(x=this.gamedata.buttons[c].defaultkeys),this.gamedata.buttons[c].keycodes=this.determineKeyCodes(x)}for(var w=0;w<this.gamedata.buttons.length-1;w++)for(var S=w+1;S<this.gamedata.buttons.length;S++)if(this.gamedata.buttons[w].area.x1<this.gamedata.buttons[S].area.x2&&this.gamedata.buttons[w].area.x2>this.gamedata.buttons[S].area.x1&&this.gamedata.buttons[w].area.y1<this.gamedata.buttons[S].area.y2&&this.gamedata.buttons[w].area.y2>this.gamedata.buttons[S].area.y1){var _=this.gamedata.buttons[w].area.xc,E=this.gamedata.buttons[w].area.yc,L=this.gamedata.buttons[S].area.xc,I=this.gamedata.buttons[S].area.yc;if(Math.abs(_-L)>Math.abs(E-I))if(L<_){var k=(this.gamedata.buttons[w].area.x1-this.gamedata.buttons[S].area.x2)/2;this.gamedata.buttons[w].area.x1-=k,this.gamedata.buttons[S].area.x2+=k}else{k=(this.gamedata.buttons[w].area.x2-this.gamedata.buttons[S].area.x1)/2;this.gamedata.buttons[w].area.x2-=k,this.gamedata.buttons[S].area.x1+=k}else if(I<E){k=(this.gamedata.buttons[w].area.y1-this.gamedata.buttons[S].area.y2)/2;this.gamedata.buttons[w].area.y1-=k,this.gamedata.buttons[S].area.y2+=k}else{k=(this.gamedata.buttons[w].area.y2-this.gamedata.buttons[S].area.y1)/2;this.gamedata.buttons[w].area.y2-=k,this.gamedata.buttons[S].area.y1+=k}}},onConfigError:function(t){console.log("** ERROR ** lcdgame.js - onConfigError: error loading json file"),console.error(t)},loadMetadata:function(t){var e=new XMLHttpRequest;e.onreadystatechange=function(){e.readyState===XMLHttpRequest.DONE&&(200===e.status||0===e.status?this.onMetadataLoad(JSON.parse(e.responseText)):this.onMetadataError(e))}.bind(this),e.open("GET",t,!0),e.send()},tinyMarkDown:function(t){return t=(t=(t=(t=(t=t.replace(/\n/gi,"<br/>")).replace(/\*.*?\*/g,function(t){return"<b>"+t.slice(1,-1)+"</b>"})).replace(/\_.*?\_/g,function(t){return"<i>"+t.slice(1,-1)+"</i>"})).replace(/\[(?:(?!\[).)*?\](?!\()/g,function(t){return"<btn>"+t.slice(1,-1)+"</btn>"})).replace(/(\[(?:(?!\[).)*?\])(\((?:(?!\().)*?\))/g,function(t,e,a,s){var i=a.slice(1,-1);return 0!=i.indexOf("http")&&(i="http://"+i),'<a href="'+i+'">'+e.slice(1,-1)+"</a>"})},onMetadataLoad:function(t){this.metadata=t;var e=this.tinyMarkDown(t.gameinfo.instructions.en);this.infocontent.innerHTML="<h1>How to play</h1><br/>"+e;var a=t.gameinfo.device.title,s=t.gameinfo.gametypes;this.gametype=void 0===s?0:1,this.highscores=new LCDGame.HighScores(this,a,s),this.highscores.init(this.gametype)},onMetadataError:function(t){console.log("** ERROR ** lcdgame.js - onMetadataError: error loading json file"),console.error(t)},resizeCanvas:function(){var t=window.innerWidth/window.innerHeight,e=this.canvas.width/this.canvas.height,a=this.canvas.width,s=this.canvas.height;if(t<e){a=window.innerWidth,this.scaleFactor=a/this.canvas.width,s=this.canvas.height*this.scaleFactor;var i=(window.innerHeight-s)/2;this.canvas.style["margin-top"]=i+"px",this.canvas.style["margin-bottom"]=-i+"px",this.canvas.style["margin-left"]="0px"}else{s=window.innerHeight,this.scaleFactor=s/this.canvas.height,a=this.canvas.width*this.scaleFactor;var n=(window.innerWidth-a)/2;this.canvas.style["margin-left"]=n+"px",this.canvas.style["margin-right"]=-n+"px",this.canvas.style["margin-top"]="0px"}this.canvas.style.width=a+"px",this.canvas.style.height=s+"px",this.canvas.style.display="block",this.canvas.style["touch-action"]="none",this.canvas.style["user-select"]="none",this.canvas.style["-webkit-tap-highlight-color"]="rgba(0, 0, 0, 0)",this.resizeInfobox(this.infobox),this.resizeInfobox(this.scorebox)},resizeInfobox:function(t){t.style.display="inherit";var e=t.offsetWidth,a=t.offsetHeight,s=t.getBoundingClientRect();s&&(e=s.width,a=s.height);var i=(window.innerWidth-e)/2,n=(window.innerHeight-a)/2;t.style["margin-left"]=i+"px",t.style["margin-right"]=-i+"px",t.style["margin-top"]=n+"px",t.style["margin-bottom"]=-n+"px",t.style.display="none"},initGame:function(){document.body.scrollTop=0,document.body.style.overflow="hidden",this.canvas.width=this.imageBackground.width,this.canvas.height=this.imageBackground.height,this.context2d.drawImage(this.imageBackground,0,0);for(var t=0;t<this.gamedata.sounds.length;t++){var e=this.gamedata.sounds[t].filename;this.gamedata.sounds[t].audio=new Audio(e),this.gamedata.sounds[t].audio.load()}("ontouchstart"in document.documentElement||window.navigator.maxTouchPoints&&1<=window.navigator.maxTouchPoints)&&(this._touchdevice=!0),document.addEventListener?(this.canvas.addEventListener("mousedown",this.onmousedown.bind(this),!1),this.canvas.addEventListener("mouseup",this.onmouseup.bind(this),!1),document.addEventListener("keydown",this.onkeydown.bind(this),!1),document.addEventListener("keyup",this.onkeyup.bind(this),!1),this._touchdevice&&(this.canvas.addEventListener("touchstart",this.ontouchstart.bind(this),!1),this.canvas.addEventListener("touchend",this.ontouchend.bind(this),!1))):(this.canvas.attachEvent("mousedown",this.onmousedown.bind(this)),this.canvas.attachEvent("mouseup",this.onmouseup.bind(this)),document.attachEvent("keydown",this.onkeydown.bind(this)),document.attachEvent("keyup",this.onkeyup.bind(this))),window.addEventListener("resize",this.resizeCanvas.bind(this),!1),this.resizeCanvas(),displayInfobox(),this.raf.start(),console.log("lcdgame.js v"+LCDGAME_VERSION+" :: start")},addtimer:function(t,e,a,s){void 0===s&&(s=!0);var i=new LCDGame.Timer(t,e,a,s);return this.timers.push(i),i},cleartimers:function(){for(var t=0;t<this.timers.length;t++)this.timers[t].pause(),this.timers[t]=null;this.timers=[]},updateloop:function(t){for(var e=0;e<this.timers.length;e++)this.timers[e].enabled&&this.timers[e].update(t);this._refresh&&(this.shapesRefresh(),this._refresh=!1)},gameReset:function(t){this.score=0,this.level=0,this.gametype=t,this.buttonpress=0,this.playtimestart=new Date},loadSoundEffects:function(){console.log("loadSoundEffects - TODO load sound effects")},setSoundMute:function(t){this.soundmute=t},soundIndexByName:function(t){for(var e=0;e<this.gamedata.sounds.length;e++)if(this.gamedata.sounds[e].name==t)return e;return-1},playSoundEffect:function(t){if(!this.soundmute){var e=this.soundIndexByName(t);0<=e&&(0==this.gamedata.sounds[e].audio.paused&&(this.gamedata.sounds[e].audio.pause(),isNaN(this.gamedata.sounds[e].audio.duration)||(this.gamedata.sounds[e].audio.currentTime=0)),this.gamedata.sounds[e].audio.play())}},randomInteger:function(t,e){return e=e-t+1,Math.floor(Math.random()*e)+t},shapeIndexByName:function(t){for(var e=0;e<this.gamedata.frames.length;e++)if(this.gamedata.frames[e].filename==t)return e;throw console.log("** ERROR ** shapeIndexByName('"+t+"') - filename not found."),"lcdgames.js - "+arguments.callee.caller.toString()+", no frame with filename '"+t+"'"},setShapeByName:function(t,e){if(this.gamedata.frames){for(var a=0;a<this.gamedata.frames.length;a++)if(this.gamedata.frames[a].filename==t)return this.gamedata.frames[a].value=e,this._refresh=!0;throw"lcdgames.js - "+arguments.callee.caller.toString()+", no frame with filename '"+t+"'"}return!1},setShapeByIdx:function(t,e){return this.gamedata.frames[t].value=e,this._refresh=!0},sequenceIndexByName:function(t){if(this.gamedata.sequences){for(var e=0;e<this.gamedata.sequences.length;e++)if(this.gamedata.sequences[e].name==t)return e;throw console.log("** ERROR ** sequenceIndexByName('"+t+"') - sequence name not found."),"lcdgames.js - "+arguments.callee.caller.toString()+", no sequence with name '"+t+"'"}return-1},sequenceResetAll:function(t,e){void 0===e&&(e=!1);for(var a=this.sequenceIndexByName(t),s=0;s<this.gamedata.sequences[a].ids.length;s++){var i=this.gamedata.sequences[a].ids[s];this.gamedata.frames[i].value=e}this._refresh=!0},sequenceClear:function(t){this.sequenceResetAll(t)},sequenceShift:function(t,e){var a,s=this.sequenceIndexByName(t);void 0===e&&(e=this.gamedata.sequences[s].ids.length);var i=!1;for(a=e-1;0<a;a--){var n=this.gamedata.sequences[s].ids[a-1],o=this.gamedata.sequences[s].ids[a];a==e-1&&(i=this.gamedata.frames[o].value),this.gamedata.frames[o].value=this.gamedata.frames[n].value}n=this.gamedata.sequences[s].ids[0];return this.gamedata.frames[n].value=!1,this._refresh=!0,i},sequenceShiftReverse:function(t,e){var a,s=this.sequenceIndexByName(t);for(void 0===e&&(e=0),a=e;a<this.gamedata.sequences[s].ids.length-1;a++){var i=this.gamedata.sequences[s].ids[a],n=this.gamedata.sequences[s].ids[a+1];this.gamedata.frames[i].value=this.gamedata.frames[n].value}i=this.gamedata.sequences[s].ids[a];this.gamedata.frames[i].value=!1,this._refresh=!0},sequenceSetFirst:function(t,e){var a=this.sequenceIndexByName(t),s=this.gamedata.sequences[a].ids[0];this.gamedata.frames[s].value=e,this._refresh=!0},sequenceSetPos:function(t,e,a){if(this.gamedata.sequences){var s=this.sequenceIndexByName(t);if(-1==e&&(e=this.gamedata.sequences[s].ids.length-1),e<this.gamedata.sequences[s].ids.length){var i=this.gamedata.sequences[s].ids[e];this.gamedata.frames[i].value=a,this._refresh=!0}}},shapeVisible:function(t){for(var e=0;e<this.gamedata.frames.length;e++)if(this.gamedata.frames[e].filename==t&&1==this.gamedata.frames[e].value)return!0;return!1},sequenceShapeVisible:function(t,e){var a=this.sequenceIndexByName(t);if(void 0===e)for(var s=0;s<this.gamedata.sequences[a].ids.length;s++){var i=this.gamedata.sequences[a].ids[s];if(1==this.gamedata.frames[i].value)return!0}else if(-1==e&&(e=this.gamedata.sequences[a].ids.length-1),e<this.gamedata.sequences[a].ids.length){i=this.gamedata.sequences[a].ids[e];if(1==this.gamedata.frames[i].value)return!0}return!1},sequenceAllVisible:function(t,e){for(var a=this.sequenceIndexByName(t),s=0;s<this.gamedata.sequences[a].ids.length;s++){var i=this.gamedata.sequences[a].ids[s];if(this.gamedata.frames[i].value!=e)return!1}return!0},shapesDisplayAll:function(t){if(this.gamedata.frames){for(var e=0;e<this.gamedata.frames.length;e++)"shape"!=this.gamedata.frames[e].type&&"digitpos"!=this.gamedata.frames[e].type||(this.gamedata.frames[e].value=t);if(1==t)for(e=0;e<this.gamedata.digits.length;e++)this.digitsDisplay(this.gamedata.digits[e].name,this.gamedata.digits[e].max);this._refresh=!0}},digitsDisplay:function(t,e,a){if(this.gamedata.digits){for(var s=-1,i=0;i<this.gamedata.digits.length;i++)if(this.gamedata.digits[i].name==t){s=i;break}if(-1==s)throw console.log("** ERROR ** digitsDisplay('"+t+"') - digits not found."),"lcdgames.js - digitsDisplay, no digits with name '"+t+"'";var n=0,o=0;1==a&&(o=this.gamedata.digits[s].locids.length-e.length)<0&&(n=Math.abs(o),o=0);for(i=0;i<this.gamedata.digits[s].locids.length;i++){var r=this.gamedata.digits[s].locids[i];if(i<o||n>=e.length)this.gamedata.frames[r].value=!1;else{var h=e.charCodeAt(n)-48;if(0<=h&&h<this.gamedata.digits[s].ids.length){var d=this.gamedata.digits[s].ids[h];this.gamedata.frames[r].frame.x=this.gamedata.frames[d].frame.x,this.gamedata.frames[r].frame.y=this.gamedata.frames[d].frame.y,this.gamedata.frames[r].value=!0}else this.gamedata.frames[r].value=!1;n+=1}}this._refresh=!0}},shapesRefresh:function(){if(this.gamedata.frames){this.context2d.drawImage(this.imageBackground,0,0);for(var t=0;t<this.gamedata.frames.length;t++)1==this.gamedata.frames[t].value&&this.shapeDraw(t);this.drawDebugText()}this._refresh=!1},shapeDraw:function(t){this.context2d.drawImage(this.imageShapes,this.gamedata.frames[t].frame.x,this.gamedata.frames[t].frame.y,this.gamedata.frames[t].frame.w,this.gamedata.frames[t].frame.h,this.gamedata.frames[t].spriteSourceSize.x,this.gamedata.frames[t].spriteSourceSize.y,this.gamedata.frames[t].spriteSourceSize.w,this.gamedata.frames[t].spriteSourceSize.h)},debugText:function(t){this.debugtxt=t},drawDebugText:function(){if(this.debugtxt){this.context2d.font="bold 24px sans-serif";for(var t=50,e=this.debugtxt.split("\n"),a=0;a<e.length;a++)this.context2d.fillStyle="#000",this.context2d.fillText(e[a],52,t+2),this.context2d.fillStyle="#fff",this.context2d.fillText(e[a],50,t),t+=15}},buttonAdd:function(t,e,a){void 0===this.buttons&&(this.buttons=[]);var s=this.gamedata.buttons.length;this.gamedata.buttons[s]={},this.gamedata.buttons[s].name=t,this.gamedata.buttons[s].frames=e,this.gamedata.buttons[s].defaultkeys=a,this.gamedata.buttons[s].keycodes=this.determineKeyCodes(a)},determineKeyCodes:function(t){for(var e=[],a=0;a<t.length;a++){var s=0,i=t[a];s=-1<(i=i.toUpperCase()).indexOf("PGUP")?33:-1<i.indexOf("PGDN")?34:-1<i.indexOf("END")?35:-1<i.indexOf("HOME")?36:-1<i.indexOf("UP")?38:-1<i.indexOf("DOWN")?40:-1<i.indexOf("LEFT")?37:-1<i.indexOf("RIGHT")?39:i.charCodeAt(0),e.push(s)}return e},ontouchstart:function(t){t.preventDefault();for(var e=0;e<event.changedTouches.length;e++)this.onmousedown(event.changedTouches[e])},ontouchend:function(t){t.preventDefault();for(var e=0;e<t.changedTouches.length;e++)this.onmouseup(t.changedTouches[e])},onmousedown:function(t){var e=t.offsetX||t.clientX-t.target.offsetLeft,a=t.offsetY||t.clientY-t.target.offsetTop;e/=this.scaleFactor,a/=this.scaleFactor;for(var s=0;s<this.gamedata.buttons.length;s++)if(e>this.gamedata.buttons[s].area.x1&&e<this.gamedata.buttons[s].area.x2&&a>this.gamedata.buttons[s].area.y1&&a<this.gamedata.buttons[s].area.y2){var i=0;switch(this.gamedata.buttons[s].type){case"updown":var n=(this.gamedata.buttons[s].area.y2-this.gamedata.buttons[s].area.y1)/2;i=a<this.gamedata.buttons[s].area.y1+n?0:1;break;case"leftright":var o=(this.gamedata.buttons[s].area.x2-this.gamedata.buttons[s].area.x1)/2;i=e<this.gamedata.buttons[s].area.x1+o?0:1;break;case"dpad":o=(this.gamedata.buttons[s].area.x2-this.gamedata.buttons[s].area.x1)/2,n=(this.gamedata.buttons[s].area.y2-this.gamedata.buttons[s].area.y1)/2;var r=e-this.gamedata.buttons[s].area.x1-o,h=a-this.gamedata.buttons[s].area.y1-n;i=Math.abs(r)<Math.abs(h)?h<0?0:1:r<0?2:3}this.onButtonDown(s,i)}},onmouseup:function(t){for(var e=t.offsetX||t.clientX-t.target.offsetLeft,a=t.offsetY||t.clientY-t.target.offsetTop,s=(e=e/this.scaleFactor,a=a/this.scaleFactor,0);s<this.gamedata.buttons.length;s++)if(e>this.gamedata.buttons[s].area.x1&&e<this.gamedata.buttons[s].area.x2&&a>this.gamedata.buttons[s].area.y1&&a<this.gamedata.buttons[s].area.y2){var i=0;switch(this.gamedata.buttons[s].type){case"updown":var n=(this.gamedata.buttons[s].area.y2-this.gamedata.buttons[s].area.y1)/2;i=a<this.gamedata.buttons[s].area.y1+n?0:1;break;case"leftright":n=(this.gamedata.buttons[s].area.x2-this.gamedata.buttons[s].area.x1)/2;i=e<this.gamedata.buttons[s].area.x1+n?0:1;break;case"dpad":var o=(this.gamedata.buttons[s].area.x2-this.gamedata.buttons[s].area.x1)/2,r=(this.gamedata.buttons[s].area.y2-this.gamedata.buttons[s].area.y1)/2,h=e-this.gamedata.buttons[s].area.x1-o,d=a-this.gamedata.buttons[s].area.y1-r;i=Math.abs(h)<Math.abs(d)?d<0?0:1:h<0?2:3}this.onButtonUp(s,i)}},onkeydown:function(t){for(var e=t.keyCode,a=0;a<this.gamedata.buttons.length;a++)for(var s=0;s<this.gamedata.buttons[a].keycodes.length;s++)this.gamedata.buttons[a].keycodes[s]==e&&this.onButtonDown(a,s)},onkeyup:function(t){for(var e=t.keyCode,a=0;a<this.gamedata.buttons.length;a++)for(var s=0;s<this.gamedata.buttons[a].keycodes.length;s++)this.gamedata.buttons[a].keycodes[s]==e&&this.onButtonUp(a)},onButtonDown:function(t,e){var a=this.gamedata.buttons[t].name;e>=this.gamedata.buttons[t].ids.length&&(e%=this.gamedata.buttons[t].ids.length),this.state.currentState().press(a,e),this.buttonpress++;var s=this.gamedata.buttons[t].ids[e];this.setShapeByIdx(s,!0)},onButtonUp:function(t,e){for(var a=0;a<this.gamedata.buttons[t].ids.length;a++){var s=this.gamedata.buttons[t].ids[a];this.setShapeByIdx(s,!1)}if(void 0!==this.state.currentState().release){var i=this.gamedata.buttons[t].name;this.state.currentState().release(i,e)}},debugRectangle:function(t,e,a,s){this.context2d.beginPath(),this.context2d.lineWidth="1",this.context2d.strokeStyle="#f0f",this.context2d.fillStyle="#f0f",this.context2d.rect(t,e,a,s),this.context2d.stroke()},is_touch_device:function(){var t=document.createElement("div");return t.setAttribute("lcdgame.js - ongesturestart","return;"),"function"==typeof t.ongesturestart}},LCDGame.BPMToMillSec=function(t){return 6e4/t},LCDGame.Shape=function(t,e){this.lcdgame=t,this.framename=e,this.idx=0},LCDGame.Button=function(t,e){this.lcdgame=t,this.name=e,this.keycodes=[]},LCDGame.Timer=function(t,e,a,s){this.context=t,this.callback=e,this.interval=a||1e3,this.waitfirst=s,this.counter=0,this.max=null,this.enabled=!1,this.timerId=0,this.lasttime=0},LCDGame.Timer.prototype={update:function(t){this.callback.name;t-this.lasttime>=this.interval&&(this.lasttime=this.lasttime+this.interval,this.doTimerEvent())},doTimerEvent:function(){this.counter++,this.callback.call(this.context,this),void 0!==this.max&&this.counter>=this.max&&(this.enabled=!1)},start:function(t,e){void 0!==e&&(this.waitfirst=e),this.enabled=!0,this.counter=0,this.max=t,this.lasttime=this.context.lcdgame.raf.raftime||0,0==this.waitfirst&&(this.lasttime-=this.interval)},pause:function(){this.enabled=!1},unpause:function(){this.lasttime=this.context.lcdgame.raf.raftime||0,0==this.waitfirst&&(this.lasttime-=this.interval),this.enabled=!0}};